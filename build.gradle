plugins {
    id 'java'
    id 'application'
    id 'edu.sc.seis.launch4j' version '3.0.5'
}


ext {
    // Define osgi.platform for SWT dependency resolution
    setProperty('osgi.platform', 'win32.win32.x86_64')
}

group = 'org.tvrenamer'
version = '1.0.0-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // SWT - using platform specific dependency for Windows build
    // Exclude transitive dependencies to prevent resolution of '${osgi.platform}'
    implementation('org.eclipse.platform:org.eclipse.swt.win32.win32.x86_64:3.124.0') {
        transitive = false
    }
    
    // Core dependencies - modernized
    implementation 'com.thoughtworks.xstream:xstream:1.4.20'
    implementation 'commons-codec:commons-codec:1.16.0'
    implementation 'xpp3:xpp3_min:1.1.4c' // Often needed by XStream legacy
    implementation 'xmlpull:xmlpull:1.1.3.1'
    
    // Networking
    implementation 'com.squareup.okhttp3:okhttp:4.12.0'
    
    // Testing
    testImplementation 'junit:junit:4.13.2'
}

application {
    mainClass = 'org.tvrenamer.controller.Launcher'
    // Default JVM args if needed
    // applicationDefaultJvmArgs = []
}

launch4j {
    mainClassName = 'org.tvrenamer.controller.Launcher'
    icon = "${projectDir}/src/main/resources/icons/oldschool-tv-icon.ico"
    jarTask = project.tasks.jar
    outfile = "TVRenamer.exe"
    downloadUrl = "http://java.com/download"
    headerType = "gui"
    requires64Bit = true
    jreMinVersion = "17"
}

tasks.named('processResources') {
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// Create a fat JAR with all dependencies EXCEPT SWT (SWT needs special handling)
tasks.register('fatJar', Jar) {
    archiveClassifier = 'all'
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    manifest {
        attributes 'Main-Class': 'org.tvrenamer.controller.Launcher'
        // Add classpath for SWT which must be loaded separately
        attributes 'Class-Path': 'swt.jar'
    }
    from {
        configurations.runtimeClasspath
            .filter { !it.name.contains('swt') }
            .collect { it.isDirectory() ? it : zipTree(it) }
    }
    with jar
}

// Copy SWT jar separately for use with the fat JAR
tasks.register('copySwtJar', Copy) {
    from configurations.runtimeClasspath.filter { it.name.contains('swt') }
    into "${buildDir}/libs"
    rename { 'swt.jar' }
}

// Create distribution with proper structure
tasks.register('createDist', Copy) {
    dependsOn 'fatJar', 'copySwtJar'
    from("${buildDir}/libs") {
        include '*.jar'
    }
    into "${buildDir}/dist"
}

// Ensure resources are copied if they are in src/main/resources or similar
// If source structure is non-standard, we might need to configure sourceSets
sourceSets {
    main {
        java {
            srcDir 'src/main/java'
        }
        resources {
            srcDir 'src/main/resources'
        }
    }
    test {
        java {
            srcDir 'src/test/java'
        }
    }
}
